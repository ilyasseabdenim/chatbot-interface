<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbot Builder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.auth0.com/js/auth0-spa-js/2.0/auth0-spa-js.production.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body class="bg-slate-100">

    <!-- Auth0 Login View -->
    <div id="login-view" class="flex items-center justify-center h-screen">
        <div class="text-center p-8 bg-white shadow-lg rounded-xl">
            <h1 class="text-3xl font-bold mb-2">Chatbot Builder</h1>
            <p class="text-slate-600 mb-6">Please log in to continue.</p>
            <button id="login-button" class="bg-indigo-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-indigo-700 transition">Log In</button>
        </div>
    </div>

    <!-- Chatbot Builder View (Initially Hidden) -->
    <div id="chat-view" class="hidden p-4 md:p-8">
        <div class="max-w-7xl mx-auto">
            <header class="text-center mb-8">
                <div class="flex justify-between items-center mb-4">
                    <div></div> <!-- Spacer -->
                    <div class="inline-flex items-center bg-indigo-100 text-indigo-700 py-2 px-4 rounded-full">
                        <i data-feather="zap" class="w-5 h-5 mr-2"></i>
                        <h1 class="text-2xl md:text-4xl font-bold tracking-tight">BotBuilder <span class="text-indigo-600">Buzz</span></h1>
                    </div>
                    <button id="logout-button" class="bg-slate-200 text-slate-700 font-semibold py-2 px-4 rounded-lg hover:bg-slate-300 transition">Log Out</button>
                </div>
                <p class="text-slate-600 max-w-2xl mx-auto">Visually craft your chatbot conversation flow. Drag steps, configure them, and generate the code.</p>
            </header>

            <main class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
                <aside class="lg:col-span-1 bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                    <h2 class="text-lg font-semibold mb-4 text-slate-800 border-b pb-3">Step Builder</h2>
                    <div id="step-builder" class="space-y-3">
                        <div class="step-item" draggable="true" data-step-type="welcome-message"><i data-feather="message-square" class="text-indigo-500"></i><div><h3>Welcome Message</h3><p>Starts the conversation.</p></div></div>
                        <div class="step-item" draggable="true" data-step-type="question-text"><i data-feather="help-circle" class="text-sky-500"></i><div><h3>Question (Text)</h3><p>Asks user for text input.</p></div></div>
                        <div class="step-item" draggable="true" data-step-type="question-multiple-choice"><i data-feather="list" class="text-purple-500"></i><div><h3>Question (Multiple Choice)</h3><p>Asks user to choose an option.</p></div></div>
                        <div class="step-item" draggable="true" data-step-type="form"><i data-feather="file-text" class="text-orange-500"></i><div><h3>Form</h3><p>Display a form with questions.</p></div></div>
                        <div class="step-item" draggable="true" data-step-type="show-message"><i data-feather="align-left" class="text-emerald-500"></i><div><h3>Show Message</h3><p>Displays a message from the bot.</p></div></div>
                        <div class="step-item" draggable="true" data-step-type="end-conversation"><i data-feather="flag" class="text-red-500"></i><div><h3>End Conversation</h3><p>Finishes the chat flow.</p></div></div>
                    </div>
                </aside>

                <section class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-sm border border-slate-200 relative">
                    <h2 class="text-lg font-semibold mb-4 text-slate-800 border-b pb-3">Bot Preview Board</h2>
                    <div id="bot-preview-board" class="p-4 rounded-lg space-y-4 relative"></div>
                    <div id="drop-placeholder" class="placeholder-center text-center text-slate-400">
                        <i data-feather="move" class="w-10 h-10 mx-auto mb-2"></i>
                        <p class="font-medium">Drag and drop steps here</p>
                    </div>
                </section>
            </main>

            <section class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                <div class="flex flex-col sm:flex-row items-center justify-between mb-4 gap-4">
                    <h2 class="text-lg font-semibold text-slate-800">Generated Bot Code</h2>
                    <div class="flex items-center gap-2">
                        <button id="generate-btn" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 transition flex items-center"><i data-feather="code" class="w-4 h-4 mr-2"></i>Generate</button>
                        <button id="copy-btn" class="bg-slate-200 text-slate-700 font-semibold py-2 px-4 rounded-lg hover:bg-slate-300 transition flex items-center" disabled><i data-feather="copy" class="w-4 h-4 mr-2"></i>Copy</button>
                        <button id="download-btn" class="bg-slate-200 text-slate-700 font-semibold py-2 px-4 rounded-lg hover:bg-slate-300 transition flex items-center" disabled><i data-feather="download" class="w-4 h-4 mr-2"></i>Download</button>
                    </div>
                </div>
                <div id="generated-bot-content" class="bg-slate-900 text-white rounded-lg p-4 font-mono text-sm overflow-x-auto min-h-[200px]">
                    <pre><code id="code-output">Click "Generate" to see the result here.</code></pre>
                </div>
            </section>
        </div>
    </div>

    <div id="edit-modal-overlay" class="modal-overlay">
        <div class="modal-content">
            <h3 id="modal-title" class="text-lg font-bold mb-4">Edit Step</h3>
            <div id="modal-body" class="space-y-4"></div>
            <div class="flex justify-end gap-3 mt-6">
                <button id="modal-cancel-btn" class="bg-slate-200 text-slate-700 font-semibold py-2 px-4 rounded-lg hover:bg-slate-300">Cancel</button>
                <button id="modal-save-btn" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700">Save Changes</button>
            </div>
        </div>
    </div>

    <script>
        let auth0Client = null;

        // --- AUTH0 AUTHENTICATION LOGIC (Unchanged and Working) ---
        async function initAuth0() {
            try { auth0Client = await auth0.createAuth0Client({ domain: 'dev-mz8c8fsonw81ep0j.us.auth0.com', clientId: 'FPVfw1307EHppIuL8elWrE6KcBzS8Ubq', authorizationParams: { redirect_uri: window.location.origin } }); } catch (err) { console.error("Error initializing Auth0 client:", err); }
        }
        async function login() { try { await auth0Client.loginWithRedirect(); } catch (err) { console.error("Login failed:", err); } }
        function logout() { auth0Client.logout({ logoutParams: { returnTo: window.location.origin } }); }
        async function handleAuthCallback() { const i = await auth0Client.isAuthenticated(); if (i) { await updateUI(); return; } const q = window.location.search; if (q.includes("code=") && q.includes("state=")) { await auth0Client.handleRedirectCallback(); await updateUI(); window.history.replaceState({}, document.title, "/"); } }
        async function updateUI() { const i = await auth0Client.isAuthenticated(); document.getElementById('login-view').classList.toggle('hidden', i); document.getElementById('chat-view').classList.toggle('hidden', !i); if (i) { initializeBuilder(); } }

        // --- BOT BUILDER LOGIC (Corrected and Complete) ---
        let builderInitialized = false;

        function initializeBuilder() {
            if (builderInitialized) return;
            builderInitialized = true;

            feather.replace();
            
            const stepBuilder = document.getElementById('step-builder');
            const previewBoard = document.getElementById('bot-preview-board');
            const generateBtn = document.getElementById('generate-btn');
            const copyBtn = document.getElementById('copy-btn');
            const downloadBtn = document.getElementById('download-btn');
            const codeOutput = document.getElementById('code-output');
            const modalOverlay = document.getElementById('edit-modal-overlay');
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body');
            const modalSaveBtn = document.getElementById('modal-save-btn');
            const modalCancelBtn = document.getElementById('modal-cancel-btn');

            // Drag and Drop Logic
            stepBuilder.querySelectorAll('.step-item').forEach(item => {
                item.addEventListener('dragstart', (e) => { e.dataTransfer.setData('text/plain', item.dataset.stepType); setTimeout(() => item.classList.add('dragging'), 0); });
                item.addEventListener('dragend', () => item.classList.remove('dragging'));
            });

            previewBoard.addEventListener('dragover', (e) => { e.preventDefault(); const d = document.querySelector('.dragging-preview'); if (d) { const a = getDragAfterElement(previewBoard, e.clientY); if (a == null) { previewBoard.appendChild(d); } else { previewBoard.insertBefore(d, a); } } else { previewBoard.classList.add('drag-over'); } });
            previewBoard.addEventListener('dragleave', () => previewBoard.classList.remove('drag-over'));
            previewBoard.addEventListener('drop', (e) => { e.preventDefault(); previewBoard.classList.remove('drag-over'); const s = e.dataTransfer.getData('text/plain'); if (s) { addStepToPreview(s); e.dataTransfer.clearData(); } });
            
            // Reordering Logic
            previewBoard.addEventListener('dragstart', e => { if (e.target.classList.contains('preview-step')) { setTimeout(() => e.target.classList.add('dragging-preview'), 0); } });
            previewBoard.addEventListener('dragend', e => { if (e.target.classList.contains('preview-step')) { e.target.classList.remove('dragging-preview'); } });
            function getDragAfterElement(c, y) { const d = [...c.querySelectorAll('.preview-step:not(.dragging-preview)')]; return d.reduce((closest, child) => { const box = child.getBoundingClientRect(); const offset = y - box.top - box.height / 2; if (offset < 0 && offset > closest.offset) { return { offset: offset, element: child }; } else { return closest; } }, { offset: Number.NEGATIVE_INFINITY }).element; }

            // Step Creation, Deletion, Editing
            let stepIdCounter = 0;
            function addStepToPreview(stepType) {
                const stepId = `step-${stepIdCounter++}`;
                const tempDiv = document.createElement('div');
                let initialData, title, icon, color;
                switch(stepType) {
                    case 'welcome-message': [title, icon, color] = ['Welcome Message', 'message-square', 'indigo']; initialData = { value: ''}; break;
                    case 'question-text': [title, icon, color] = ['Question (Text)', 'help-circle', 'sky']; initialData = { value: '', variableName: '' }; break;
                    case 'question-multiple-choice': [title, icon, color] = ['Question (Multiple Choice)', 'list', 'purple']; initialData = { value: '', options: [], variableName: '' }; break;
                    case 'form': [title, icon, color] = ['Form', 'file-text', 'orange']; initialData = { title: '', questions: [] }; break;
                    case 'show-message': [title, icon, color] = ['Show Message', 'align-left', 'emerald']; initialData = { value: '' }; break;
                    case 'end-conversation': [title, icon, color] = ['End Conversation', 'flag', 'red']; initialData = { value: '' }; break;
                    default: return;
                }
                tempDiv.innerHTML = createStepElement(stepId, title, icon, color, stepType);
                const stepElement = tempDiv.firstElementChild;
                stepElement.querySelector('.step-data').textContent = JSON.stringify(initialData);
                previewBoard.appendChild(stepElement);
                feather.replace();
            }
            function createStepElement(id, title, icon, color, stepType) {
                 return `<div id="${id}" class="preview-step bg-slate-50 p-4 rounded-lg border border-${color}-200 shadow-sm" data-step-type="${stepType}" draggable="true"><div class="step-data" style="display: none;"></div><div class="flex justify-between items-center"><div class="flex items-center" style="cursor: grab;"><i data-feather="${icon}" class="w-5 h-5 mr-3 text-${color}-500"></i><h4 class="font-semibold text-slate-700">${title}</h4></div><div class="flex items-center gap-2"><button class="edit-step-btn text-slate-400 hover:text-indigo-500 transition-colors"><i data-feather="edit" class="w-5 h-5" style="pointer-events: none;"></i></button><button class="delete-step-btn text-slate-400 hover:text-red-500 transition-colors"><i data-feather="x-circle" class="w-5 h-5" style="pointer-events: none;"></i></button></div></div><div class="step-content-display text-sm text-slate-600 mt-2 p-2 rounded-md bg-white border min-h-[40px] italic">Click the edit button to configure this step.</div></div>`;
            }
            previewBoard.addEventListener('click', (e) => {
                const deleteButton = e.target.closest('.delete-step-btn');
                if (deleteButton) { deleteButton.closest('.preview-step').remove(); }
                const editButton = e.target.closest('.edit-step-btn');
                if (editButton) { openModal(editButton.closest('.preview-step')); }
            });
            
            // --- FIX: FULL, WORKING MODAL FUNCTIONS ---
            let questionIdCounter = 0;
            function openModal(stepEl) {
                const stepType = stepEl.dataset.stepType;
                const data = JSON.parse(stepEl.querySelector('.step-data').textContent);
                modalTitle.textContent = `Edit: ${stepEl.querySelector('h4').textContent}`;
                let formHtml = '';
                if (stepType === 'form') {
                    formHtml = `<div><label class="block text-sm font-medium text-slate-700 mb-1">Form Title</label><input id="modal-form-title" class="w-full p-2 border rounded-md" value="${data.title || ''}"></div><div class="mt-4"><h4 class="text-md font-semibold text-slate-800 mb-2">Questions</h4><div id="modal-questions-container" class="space-y-4"></div><button id="modal-add-question-btn" type="button" class="mt-3 text-sm text-indigo-600 hover:text-indigo-800 font-semibold flex items-center"><i data-feather="plus-circle" class="w-4 h-4 mr-1"></i> Add Question</button></div>`;
                    modalBody.innerHTML = formHtml;
                    const container = document.getElementById('modal-questions-container');
                    if(data.questions) data.questions.forEach(q => addFormQuestionInput(container, q));
                    document.getElementById('modal-add-question-btn').onclick = () => addFormQuestionInput(container);
                } else {
                    if (stepType.includes('question')) {
                         formHtml += `<div><label class="block text-sm font-medium text-slate-700 mb-1">Question Text</label><textarea id="modal-main-input" class="w-full p-2 border rounded-md">${data.value || ''}</textarea></div><div class="mt-4"><label class="block text-sm font-medium text-slate-700 mb-1">Variable Name</label><input id="modal-variable-name" type="text" class="w-full p-2 border rounded-md font-mono text-sm" value="${data.variableName || ''}"><p class="text-xs text-slate-500 mt-1">No spaces. Use underscores.</p></div>`;
                    } else {
                         formHtml += `<div><label class="block text-sm font-medium text-slate-700 mb-1">Message Text</label><textarea id="modal-main-input" class="w-full p-2 border rounded-md">${data.value || ''}</textarea></div>`;
                    }
                    if (stepType === 'question-multiple-choice') {
                        formHtml += `<div class="mt-4"><label class="block text-sm font-medium text-slate-700">Options</label><div id="modal-options-container" class="space-y-2 mt-1"></div><button id="modal-add-option-btn" type="button" class="mt-2 text-sm text-indigo-600 hover:text-indigo-800 font-semibold flex items-center"><i data-feather="plus-circle" class="w-4 h-4 mr-1"></i> Add Option</button></div>`;
                    }
                    modalBody.innerHTML = formHtml;
                    if (stepType === 'question-multiple-choice') {
                        const container = document.getElementById('modal-options-container');
                        if(data.options) data.options.forEach(opt => addOptionInput(container, opt));
                        document.getElementById('modal-add-option-btn').onclick = () => addOptionInput(container);
                    }
                }
                feather.replace();
                modalOverlay.dataset.editingStepId = stepEl.id;
                modalOverlay.classList.add('active');
            }
            function addFormQuestionInput(container, questionData = {}) {
                const questionId = `q-${questionIdCounter++}`;
                const div = document.createElement('div');
                div.className = 'p-3 border rounded-md bg-slate-50 relative form-question-item';
                div.dataset.questionId = questionId;
                div.innerHTML = `<button type="button" class="remove-question-btn absolute -top-2 -right-2 text-slate-400 hover:text-red-500 bg-white rounded-full"><i data-feather="x-circle" class="w-5 h-5" style="pointer-events:none;"></i></button><div class="grid grid-cols-2 gap-x-4 gap-y-3"><div class="col-span-2"><label class="block text-xs font-medium text-slate-600 mb-1">Question Label</label><input type="text" class="question-label w-full p-2 border rounded-md text-sm" value="${questionData.label || ''}"></div><div class="col-span-2"><label class="block text-xs font-medium text-slate-600 mb-1">Variable Name</label><input type="text" class="question-variable-name w-full p-2 border rounded-md text-sm font-mono" value="${questionData.variableName || ''}"></div><div><label class="block text-xs font-medium text-slate-600 mb-1">Question Type</label><select class="question-type w-full p-2 border rounded-md text-sm"><option value="text" ${questionData.type === 'text' ? 'selected' : ''}>Text</option><option value="number" ${questionData.type === 'number' ? 'selected' : ''}>Number</option><option value="date" ${questionData.type === 'date' ? 'selected' : ''}>Date</option><option value="multiple-choice" ${questionData.type === 'multiple-choice' ? 'selected' : ''}>Multiple Choice</option></select></div><div class="flex items-end"><label class="flex items-center gap-2"><input type="checkbox" class="question-required h-4 w-4 rounded" ${questionData.required ? 'checked' : ''}><span class="text-sm font-medium text-slate-700">Required</span></label></div></div><div class="question-options-wrapper mt-3" style="${questionData.type !== 'multiple-choice' ? 'display: none;' : ''}"><div class="modal-options-container space-y-2 mt-1"></div><button type="button" class="modal-add-option-btn mt-2 text-xs text-indigo-600 font-semibold flex items-center"><i data-feather="plus-circle" class="w-3 h-3 mr-1"></i> Add Option</button></div>`;
                const optionsContainer = div.querySelector('.modal-options-container');
                if (questionData.type === 'multiple-choice' && questionData.options) { questionData.options.forEach(opt => addOptionInput(optionsContainer, opt)); }
                div.querySelector('.modal-add-option-btn').onclick = () => addOptionInput(optionsContainer);
                div.querySelector('.remove-question-btn').onclick = (e) => e.target.closest('.form-question-item').remove();
                div.querySelector('.question-type').onchange = (e) => { div.querySelector('.question-options-wrapper').style.display = e.target.value === 'multiple-choice' ? 'block' : 'none'; };
                container.appendChild(div);
                feather.replace();
            }
            function addOptionInput(container, option = { label: '', value: '' }) {
                const div = document.createElement('div');
                div.className = 'grid grid-cols-2 items-center gap-2 option-item';
                div.innerHTML = `<input type="text" class="modal-option-label w-full p-2 border rounded-md text-sm" placeholder="Label" value="${option.label || ''}"><div class="flex items-center gap-2"><input type="text" class="modal-option-value flex-1 p-2 border rounded-md text-sm font-mono" placeholder="Value" value="${option.value || ''}"><button type="button" class="remove-option-btn text-slate-400 hover:text-red-500"><i data-feather="minus-circle" class="w-4 h-4" style="pointer-events:none;"></i></button></div>`;
                div.querySelector('.remove-option-btn').onclick = (e) => e.target.closest('.option-item').remove();
                container.appendChild(div);
                feather.replace();
            }
            function closeModal() { modalOverlay.classList.remove('active'); modalBody.innerHTML = ''; delete modalOverlay.dataset.editingStepId; }
            function saveModalChanges() {
                const stepId = modalOverlay.dataset.editingStepId; if (!stepId) return;
                const stepEl = document.getElementById(stepId);
                const stepType = stepEl.dataset.stepType;
                let newData;
                if (stepType === 'form') {
                    newData = { title: document.getElementById('modal-form-title').value, questions: [] };
                    document.querySelectorAll('#modal-questions-container .form-question-item').forEach(qEl => {
                        const question = { id: qEl.dataset.questionId, label: qEl.querySelector('.question-label').value.trim(), variableName: qEl.querySelector('.question-variable-name').value.trim().replace(/\s+/g, '_').toLowerCase(), type: qEl.querySelector('.question-type').value, required: qEl.querySelector('.question-required').checked, options: [] };
                        if (question.type === 'multiple-choice') { qEl.querySelectorAll('.modal-options-container .option-item').forEach(optEl => { const label = optEl.querySelector('.modal-option-label').value.trim(); const value = optEl.querySelector('.modal-option-value').value.trim(); if (label) { question.options.push({ label: label, value: value || label }); } }); }
                        if (question.label) { newData.questions.push(question); }
                    });
                } else {
                    newData = { value: document.getElementById('modal-main-input').value, options: [] };
                    if (stepType.includes('question')) { const variableInput = document.getElementById('modal-variable-name'); if (variableInput) { newData.variableName = variableInput.value.trim().replace(/\s+/g, '_').toLowerCase(); } }
                    if (stepType === 'question-multiple-choice') { document.querySelectorAll('#modal-options-container .option-item').forEach(optEl => { const label = optEl.querySelector('.modal-option-label').value.trim(); const value = optEl.querySelector('.modal-option-value').value.trim(); if (label) { newData.options.push({ label: label, value: value || label }); } }); }
                }
                stepEl.querySelector('.step-data').textContent = JSON.stringify(newData);
                updateStepDisplay(stepEl);
                closeModal();
            }
            function updateStepDisplay(stepEl) {
                 const data = JSON.parse(stepEl.querySelector('.step-data').textContent); const displayEl = stepEl.querySelector('.step-content-display'); const stepType = stepEl.dataset.stepType; let hasContent = false; let contentHtml = '';
                 if (stepType === 'form') { if (data.title || (data.questions && data.questions.length > 0)) { hasContent = true; contentHtml += `<p class="font-medium text-slate-800 break-words">${data.title || '<em>(No form title)</em>'}</p>`; if (data.questions && data.questions.length > 0) { contentHtml += '<ul class="list-disc list-inside mt-2 text-slate-600 text-xs space-y-1">'; data.questions.forEach(q => { contentHtml += `<li class="break-words">${q.label}${q.required ? ' *' : ''} <span class="text-slate-400">(${q.type})</span></li>`; }); contentHtml += '</ul>'; } }
                 } else { if (data.value || (data.options && data.options.length > 0)) { hasContent = true; contentHtml += `<p class="font-medium text-slate-800 break-words">${data.value || '<em>(No text provided)</em>'}</p>`; if(data.variableName) { contentHtml += `<div class="mt-2"><span class="px-2 py-1 text-xs rounded-full bg-slate-200 text-slate-600 font-mono">Var: ${data.variableName}</span></div>`; } if (data.options && data.options.length > 0) { contentHtml += '<ul class="list-disc list-inside mt-2 text-slate-600">'; data.options.forEach(opt => { contentHtml += `<li class="break-words">${opt.label} <span class="text-slate-500 font-mono text-xs">(val: ${opt.value})</span></li>`; }); contentHtml += '</ul>'; } } }
                 if (hasContent) { displayEl.innerHTML = contentHtml; displayEl.classList.remove('italic'); } else { displayEl.innerHTML = `Click the edit button to configure this step.`; displayEl.classList.add('italic'); }
            }

            // Button and Code Generation Logic
            modalSaveBtn.addEventListener('click', saveModalChanges);
            modalCancelBtn.addEventListener('click', closeModal);
            modalOverlay.addEventListener('click', (e) => { if (e.target === modalOverlay) closeModal(); });
            generateBtn.addEventListener('click', () => { /* ... Unchanged ... */ });
            copyBtn.addEventListener('click', function() { /* ... Unchanged ... */ });
            downloadBtn.addEventListener('click', function() { /* ... Unchanged ... */ });
            function generateBotHtml(steps, botId) { /* ... Unchanged ... */ }
            const unchangedButtonLogic = () => { generateBtn.addEventListener('click', () => { const s = []; previewBoard.querySelectorAll('.preview-step').forEach(el => { s.push({ type: el.dataset.stepType, ...JSON.parse(el.querySelector('.step-data').textContent) }); }); if (s.length === 0) { codeOutput.textContent = "Please add at least one step."; copyBtn.disabled = true; downloadBtn.disabled = true; return; } const id = crypto.randomUUID(); codeOutput.textContent = generateBotHtml(s, id); copyBtn.disabled = false; downloadBtn.disabled = false; }); copyBtn.addEventListener('click', function() { navigator.clipboard.writeText(codeOutput.textContent).then(() => { const o = this.innerHTML; this.innerHTML = '<i data-feather="check" class="w-4 h-4 mr-2"></i> Copied!'; feather.replace(); setTimeout(() => { this.innerHTML = o; feather.replace(); }, 2000); }); }); downloadBtn.addEventListener('click', function() { const b = new Blob([codeOutput.textContent], { type: 'text/html' }); const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = 'generated-chatbot.html'; a.click(); URL.revokeObjectURL(a.href); }); }; unchangedButtonLogic();
            function generateBotHtml(steps, botId) { const stepsJson = JSON.stringify(steps, null, 2); return `<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><title>Chatbot</title><script src="https://cdn.tailwindcss.com"><\/script><style>.chat-bubble-bot { background-color: #eef2ff; } .chat-bubble-user { background-color: #1e40af; color: #ffffff; }</style></head><body class="bg-slate-100 flex items-center justify-center h-screen"><div class="w-full max-w-md mx-auto bg-white rounded-2xl shadow-xl flex flex-col"><div class="p-4 border-b bg-blue-900 text-white rounded-t-2xl"><h2 class="text-xl font-bold">Chat with our Bot</h2></div><div id="chat-box" class="flex-1 p-6 overflow-y-auto"></div><div id="input-area" class="p-4 border-t bg-slate-50 rounded-b-2xl"></div></div><script>const WEB_APP_URL = 'PASTE_YOUR_DATABASE_ENDPOINT_URL_HERE'; const chatBox = document.getElementById('chat-box'); const inputArea = document.getElementById('input-area'); const botId = '${botId}'; const conversationSteps = ${stepsJson}; let currentStepIndex = 0; const collectedData = {}; function addMessage(message, sender, isHtml = false) { const bubble = document.createElement('div'); const wrapper = document.createElement('div'); wrapper.className = 'mb-4 flex ' + (sender === 'bot' ? 'justify-start' : 'justify-end'); bubble.className = 'max-w-xs p-3 rounded-xl ' + (sender === 'bot' ? 'chat-bubble-bot' : 'chat-bubble-user'); if (isHtml) { bubble.innerHTML = message; } else { bubble.textContent = message; } wrapper.appendChild(bubble); chatBox.appendChild(wrapper); chatBox.scrollTop = chatBox.scrollHeight; } function showOptions(options) { inputArea.innerHTML = ''; const container = document.createElement('div'); container.className = 'flex flex-wrap gap-2 justify-center'; options.forEach(option => { const button = document.createElement('button'); button.className = 'px-4 py-2 border border-blue-500 text-blue-600 rounded-full hover:bg-blue-100'; button.textContent = option.label; button.onclick = () => handleOptionClick(option); container.appendChild(button); }); inputArea.appendChild(container); } function handleOptionClick(option) { addMessage(option.label, 'user'); const step = conversationSteps[currentStepIndex]; if (step.variableName) { collectedData[step.variableName] = option.value; } restoreTextInput(); currentStepIndex++; setTimeout(processNextStep, 500); } function restoreTextInput() { inputArea.style.display = 'block'; inputArea.innerHTML = \`<div class="flex gap-2"><input type="text" id="user-input" class="flex-1 px-4 py-2 border rounded-full" placeholder="Type..." disabled><button id="send-btn" class="px-6 py-2 bg-blue-600 text-white rounded-full" disabled>Send</button></div>\`; document.getElementById('send-btn').addEventListener('click', handleUserInput); document.getElementById('user-input').addEventListener('keypress', e => e.key === 'Enter' && handleUserInput()); } async function processNextStep() { if (currentStepIndex >= conversationSteps.length) { disableInput(); return; } const step = conversationSteps[currentStepIndex]; switch(step.type) { case 'welcome-message': case 'show-message': addMessage(step.value, 'bot'); currentStepIndex++; setTimeout(processNextStep, 1000); break; case 'end-conversation': disableInput(); addMessage('Saving responses...', 'bot'); await saveData(); addMessage(step.value, 'bot'); break; case 'question-text': addMessage(step.value, 'bot'); enableInput(); break; case 'question-multiple-choice': addMessage(step.value, 'bot'); showOptions(step.options); break; case 'form': addMessage(step.title, 'bot'); displayForm(step); break; } } function displayForm(step) { inputArea.style.display = 'none'; const formId = \`form-\${currentStepIndex}\`; let formHtml = \`<div class="bg-white p-4 rounded-lg border space-y-4"><form id="\${formId}">\`; step.questions.forEach(q => { const inputName = q.variableName || q.id; formHtml += \`<div><label class="block text-sm font-medium text-slate-700 mb-1">\${q.label} \${q.required ? '<span class="text-red-500">*</span>' : ''}</label>\`; if (q.type === 'multiple-choice') { formHtml += \`<select name="\${inputName}" class="p-2 border rounded-md w-full" \${q.required ? 'required' : ''}><option value="">Select...</option>\`; q.options.forEach(opt => { formHtml += \`<option value="\${opt.value}">\${opt.label}</option>\`; }); formHtml += \`</select>\`; } else { formHtml += \`<input type="\${q.type}" name="\${inputName}" class="p-2 border rounded-md w-full" \${q.required ? 'required' : ''}>\`; } formHtml += \`</div>\`; }); formHtml += \`<button type="submit" class="w-full mt-4 px-6 py-2 bg-blue-600 text-white rounded-full">Submit</button></form></div>\`; addMessage(formHtml, 'bot', true); document.getElementById(formId).addEventListener('submit', (e) => { e.preventDefault(); handleFormSubmit(e.target, step); }); } function handleFormSubmit(formElement, step) { const formData = new FormData(formElement); let summary = '<strong>Submission:</strong><ul>'; for(let [name, value] of formData.entries()) { const q = step.questions.find(q => (q.variableName || q.id) === name); summary += \`<li><strong>\${q.label}:</strong> \${value}</li>\`; collectedData[name] = value; } summary += '</ul>'; formElement.parentElement.innerHTML = '<p class="text-center font-semibold text-green-600">Submitted!</p>'; addMessage(summary, 'user', true); restoreTextInput(); currentStepIndex++; setTimeout(processNextStep, 500); } function handleUserInput() { const input = document.getElementById('user-input'); const message = input.value.trim(); if (!message) return; addMessage(message, 'user'); const step = conversationSteps[currentStepIndex]; if (step.variableName) { collectedData[step.variableName] = message; } input.value = ''; disableInput(); currentStepIndex++; setTimeout(processNextStep, 500); } async function saveData() { if (!WEB_APP_URL || WEB_APP_URL.includes('PASTE')) { console.error("URL not set."); return; } try { await fetch(WEB_APP_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ ...collectedData, timestamp: new Date().toISOString(), botId: botId }) }); } catch (error) { console.error('Error:', error); } } function enableInput() { const i = document.getElementById('user-input'), s = document.getElementById('send-btn'); if(i)i.disabled=false; if(s)s.disabled=false; if(i)i.focus(); } function disableInput() { const i = document.getElementById('user-input'), s = document.getElementById('send-btn'); if(i)i.disabled=true; if(s)s.disabled=true; } restoreTextInput(); setTimeout(processNextStep, 500); <\/script></body></html>`; }

            document.getElementById('logout-button').addEventListener('click', logout);
        }

        // --- INITIAL PAGE LOAD ---
        window.onload = async () => {
            await initAuth0();
            await handleAuthCallback();
            await updateUI();
            document.getElementById('login-button').addEventListener('click', login);
        };
    </script>
</body>
</html>
