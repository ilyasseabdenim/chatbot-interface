<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbot Builder</title>
    
    <!-- Third-party Scripts & Fonts -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Auth0 SDK -->
    <script src="https://cdn.auth0.com/js/auth0-spa-js/2.0/auth0-spa-js.production.js"></script>
    
    <!-- Custom Styles -->
    <link rel="stylesheet" href="styles.css">
</head>
<body class="bg-slate-100">

    <!-- Auth0 Login View -->
    <div id="login-view" class="flex items-center justify-center h-screen">
        <div class="text-center p-8 bg-white shadow-lg rounded-xl">
            <h1 class="text-3xl font-bold mb-2">Chatbot Builder</h1>
            <p class="text-slate-600 mb-6">Please log in to continue.</p>
            <button id="login-button" class="bg-indigo-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-indigo-700 transition">Log In</button>
        </div>
    </div>

    <!-- Chatbot Builder View (Initially Hidden) -->
    <div id="chat-view" class="hidden p-4 md:p-8">
        <div class="max-w-7xl mx-auto">
            <header class="text-center mb-8">
                 <div class="flex justify-between items-center mb-4">
                    <div></div> <!-- Spacer -->
                    <div class="inline-flex items-center bg-indigo-100 text-indigo-700 py-2 px-4 rounded-full">
                        <i data-feather="zap" class="w-5 h-5 mr-2"></i>
                        <h1 class="text-2xl md:text-4xl font-bold tracking-tight">BotBuilder <span class="text-indigo-600">Buzz</span></h1>
                    </div>
                    <button id="logout-button" class="bg-slate-200 text-slate-700 font-semibold py-2 px-4 rounded-lg hover:bg-slate-300 transition">Log Out</button>
                </div>
                <p class="text-slate-600 max-w-2xl mx-auto">Visually craft your chatbot conversation flow. Drag steps from the builder, configure them, and generate the code instantly.</p>
            </header>

            <main class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
                <!-- Step Builder -->
                <aside class="lg:col-span-1 bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                    <h2 class="text-lg font-semibold mb-4 text-slate-800 border-b pb-3">Step Builder</h2>
                    <div id="step-builder" class="space-y-3">
                        <div class="step-item bg-white p-4 rounded-lg border flex items-center shadow-xs" draggable="true" data-step-type="welcome-message">
                            <i data-feather="message-square" class="w-5 h-5 mr-3 text-indigo-500"></i>
                            <div><h3 class="font-semibold text-sm text-slate-700">Welcome Message</h3><p class="text-xs text-slate-500">Starts the conversation.</p></div>
                        </div>
                        <div class="step-item bg-white p-4 rounded-lg border flex items-center shadow-xs" draggable="true" data-step-type="question-text">
                            <i data-feather="help-circle" class="w-5 h-5 mr-3 text-sky-500"></i>
                            <div><h3 class="font-semibold text-sm text-slate-700">Question (Text)</h3><p class="text-xs text-slate-500">Asks user for text input.</p></div>
                        </div>
                        <div class="step-item bg-white p-4 rounded-lg border flex items-center shadow-xs" draggable="true" data-step-type="question-multiple-choice">
                            <i data-feather="list" class="w-5 h-5 mr-3 text-purple-500"></i>
                            <div><h3 class="font-semibold text-sm text-slate-700">Question (Multiple Choice)</h3><p class="text-xs text-slate-500">Asks user to choose an option.</p></div>
                        </div>
                        <div class="step-item bg-white p-4 rounded-lg border flex items-center shadow-xs" draggable="true" data-step-type="form">
                            <i data-feather="file-text" class="w-5 h-5 mr-3 text-orange-500"></i>
                            <div><h3 class="font-semibold text-sm text-slate-700">Form</h3><p class="text-xs text-slate-500">Display a form with multiple questions.</p></div>
                        </div>
                        <div class="step-item bg-white p-4 rounded-lg border flex items-center shadow-xs" draggable="true" data-step-type="show-message">
                            <i data-feather="align-left" class="w-5 h-5 mr-3 text-emerald-500"></i>
                            <div><h3 class="font-semibold text-sm text-slate-700">Show Message</h3><p class="text-xs text-slate-500">Displays a message from the bot.</p></div>
                        </div>
                        <div class="step-item bg-white p-4 rounded-lg border flex items-center shadow-xs" draggable="true" data-step-type="end-conversation">
                            <i data-feather="flag" class="w-5 h-5 mr-3 text-red-500"></i>
                            <div><h3 class="font-semibold text-sm text-slate-700">End Conversation</h3><p class="text-xs text-slate-500">Finishes the chat flow.</p></div>
                        </div>
                    </div>
                </aside>

                <!-- Bot Preview Board -->
                <section class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-sm border border-slate-200 relative">
                    <h2 class="text-lg font-semibold mb-4 text-slate-800 border-b pb-3">Bot Preview Board</h2>
                    <div id="bot-preview-board" class="p-4 rounded-lg space-y-4 relative"></div>
                    <div id="drop-placeholder" class="placeholder-center text-center text-slate-400">
                        <i data-feather="move" class="w-10 h-10 mx-auto mb-2"></i>
                        <p class="font-medium">Drag and drop steps here</p>
                    </div>
                </section>
            </main>

            <!-- Generated Code Section -->
            <section class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                <div class="flex flex-col sm:flex-row items-center justify-between mb-4 gap-4">
                    <h2 class="text-lg font-semibold text-slate-800">Generated Bot Code</h2>
                    <div class="flex items-center gap-2">
                        <button id="generate-btn" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 transition duration-300 flex items-center"><i data-feather="code" class="w-4 h-4 mr-2"></i>Generate Bot Code</button>
                        <button id="copy-btn" class="bg-slate-200 text-slate-700 font-semibold py-2 px-4 rounded-lg hover:bg-slate-300 transition duration-300 flex items-center" disabled><i data-feather="copy" class="w-4 h-4 mr-2"></i>Copy Code</button>
                        <button id="download-btn" class="bg-slate-200 text-slate-700 font-semibold py-2 px-4 rounded-lg hover:bg-slate-300 transition duration-300 flex items-center" disabled><i data-feather="download" class="w-4 h-4 mr-2"></i>Download HTML</button>
                    </div>
                </div>
                <div id="generated-bot-content" class="bg-slate-900 text-white rounded-lg p-4 font-mono text-sm overflow-x-auto min-h-[200px]">
                    <pre><code id="code-output">Click "Generate Bot Code" to see the result here.</code></pre>
                </div>
            </section>
        </div>
    </div>
    
    <!-- Modal for Editing Steps -->
    <div id="edit-modal-overlay" class="modal-overlay">
        <div class="modal-content">
            <h3 id="modal-title" class="text-lg font-bold mb-4">Edit Step</h3>
            <div id="modal-body" class="space-y-4"></div>
            <div class="flex justify-end gap-3 mt-6">
                <button id="modal-cancel-btn" class="bg-slate-200 text-slate-700 font-semibold py-2 px-4 rounded-lg hover:bg-slate-300">Cancel</button>
                <button id="modal-save-btn" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700">Save Changes</button>
            </div>
        </div>
    </div>

    <script>
        let auth0Client = null;

        // --- AUTH0 AUTHENTICATION LOGIC ---

        async function initAuth0() {
            try {
                auth0Client = await auth0.createAuth0Client({
                    domain: 'dev-mz8c8fsonw81ep0j.us.auth0.com',
                    clientId: 'FPVfw1307EHppIuL8elWrE6KcBzS8Ubq',
                    authorizationParams: {
                        redirect_uri: window.location.origin
                    }
                });
            } catch (err) {
                console.error("Error initializing Auth0 client:", err);
            }
        }

        async function login() {
            try {
                await auth0Client.loginWithRedirect();
            } catch (err) {
                console.error("Login failed:", err);
            }
        }

        function logout() {
            auth0Client.logout({
                logoutParams: {
                    returnTo: window.location.origin
                }
            });
        }

        async function handleAuthCallback() {
            const isAuthenticated = await auth0Client.isAuthenticated();
            if (isAuthenticated) {
                await updateUI();
                return;
            }
            const query = window.location.search;
            if (query.includes("code=") && query.includes("state=")) {
                await auth0Client.handleRedirectCallback();
                await updateUI();
                window.history.replaceState({}, document.title, "/");
            }
        }

        async function updateUI() {
            const isAuthenticated = await auth0Client.isAuthenticated();
            document.getElementById('login-view').classList.toggle('hidden', isAuthenticated);
            document.getElementById('chat-view').classList.toggle('hidden', !isAuthenticated);

            if (isAuthenticated) {
                initializeBuilder();
            }
        }
        
        // --- BOT BUILDER LOGIC ---

        function initializeBuilder() {
            feather.replace();
            const stepBuilder = document.getElementById('step-builder');
            const previewBoard = document.getElementById('bot-preview-board');
            const generateBtn = document.getElementById('generate-btn');
            const copyBtn = document.getElementById('copy-btn');
            const downloadBtn = document.getElementById('download-btn');
            const codeOutput = document.getElementById('code-output');
            const modalOverlay = document.getElementById('edit-modal-overlay');
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body');
            const modalSaveBtn = document.getElementById('modal-save-btn');
            const modalCancelBtn = document.getElementById('modal-cancel-btn');

            const stepItems = stepBuilder.querySelectorAll('.step-item');
            stepItems.forEach(item => {
                item.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('text/plain', item.dataset.stepType);
                    setTimeout(() => item.classList.add('dragging'), 0);
                });
                item.addEventListener('dragend', () => item.classList.remove('dragging'));
            });

            previewBoard.addEventListener('dragover', (e) => {
                e.preventDefault();
                const draggingElement = document.querySelector('.dragging-preview');
                if (draggingElement) {
                    const afterElement = getDragAfterElement(previewBoard, e.clientY);
                    if (afterElement == null) {
                        previewBoard.appendChild(draggingElement);
                    } else {
                        previewBoard.insertBefore(draggingElement, afterElement);
                    }
                } else {
                    previewBoard.classList.add('drag-over');
                }
            });

            previewBoard.addEventListener('dragleave', () => previewBoard.classList.remove('drag-over'));
            
            previewBoard.addEventListener('drop', (e) => {
                e.preventDefault();
                previewBoard.classList.remove('drag-over');
                const stepType = e.dataTransfer.getData('text/plain');
                if (stepType) {
                    addStepToPreview(stepType);
                    e.dataTransfer.clearData();
                }
            });
            
            previewBoard.addEventListener('dragstart', e => {
                if (e.target.classList.contains('preview-step')) {
                    setTimeout(() => e.target.classList.add('dragging-preview'), 0);
                }
            });

            previewBoard.addEventListener('dragend', e => {
                if (e.target.classList.contains('preview-step')) {
                    e.target.classList.remove('dragging-preview');
                }
            });

            function getDragAfterElement(container, y) {
                const draggableElements = [...container.querySelectorAll('.preview-step:not(.dragging-preview)')];
                return draggableElements.reduce((closest, child) => {
                    const box = child.getBoundingClientRect();
                    const offset = y - box.top - box.height / 2;
                    if (offset < 0 && offset > closest.offset) {
                        return { offset: offset, element: child };
                    } else {
                        return closest;
                    }
                }, { offset: Number.NEGATIVE_INFINITY }).element;
            }

            let stepIdCounter = 0;
            function addStepToPreview(stepType) {
                const stepId = `step-${stepIdCounter++}`;
                const tempDiv = document.createElement('div');
                let initialData, title, icon, color;
                switch(stepType) {
                    case 'welcome-message': [title, icon, color] = ['Welcome Message', 'message-square', 'indigo']; initialData = { value: '', options: [] }; break;
                    case 'question-text': [title, icon, color] = ['Question (Text)', 'help-circle', 'sky']; initialData = { value: '', options: [], variableName: '' }; break;
                    case 'question-multiple-choice': [title, icon, color] = ['Question (Multiple Choice)', 'list', 'purple']; initialData = { value: '', options: [], variableName: '' }; break;
                    case 'form': [title, icon, color] = ['Form', 'file-text', 'orange']; initialData = { title: '', questions: [] }; break;
                    case 'show-message': [title, icon, color] = ['Show Message', 'align-left', 'emerald']; initialData = { value: '', options: [] }; break;
                    case 'end-conversation': [title, icon, color] = ['End Conversation', 'flag', 'red']; initialData = { value: '', options: [] }; break;
                    default: return;
                }
                tempDiv.innerHTML = createStepElement(stepId, title, icon, color, stepType);
                const stepElement = tempDiv.firstElementChild;
                stepElement.querySelector('.step-data').textContent = JSON.stringify(initialData);
                previewBoard.appendChild(stepElement);
                feather.replace();
            }

            function createStepElement(id, title, icon, color, stepType) {
                 return `<div id="${id}" class="preview-step bg-slate-50 p-4 rounded-lg border border-${color}-200 shadow-sm" data-step-type="${stepType}" draggable="true"><div class="step-data" style="display: none;"></div><div class="flex justify-between items-center"><div class="flex items-center" style="cursor: grab;"><i data-feather="${icon}" class="w-5 h-5 mr-3 text-${color}-500"></i><h4 class="font-semibold text-slate-700">${title}</h4></div><div class="flex items-center gap-2"><button class="edit-step-btn text-slate-400 hover:text-indigo-500 transition-colors"><i data-feather="edit" class="w-5 h-5" style="pointer-events: none;"></i></button><button class="delete-step-btn text-slate-400 hover:text-red-500 transition-colors"><i data-feather="x-circle" class="w-5 h-5" style="pointer-events: none;"></i></button></div></div><div class="step-content-display text-sm text-slate-600 mt-2 p-2 rounded-md bg-white border min-h-[40px] italic">Click the edit button to configure this step.</div></div>`;
            }

            previewBoard.addEventListener('click', (e) => {
                const deleteButton = e.target.closest('.delete-step-btn');
                if (deleteButton) { deleteButton.closest('.preview-step').remove(); }
                const editButton = e.target.closest('.edit-step-btn');
                if (editButton) { openModal(editButton.closest('.preview-step')); }
            });
            
            let questionIdCounter = 0;
            function openModal(stepEl) {
                const stepType = stepEl.dataset.stepType;
                const data = JSON.parse(stepEl.querySelector('.step-data').textContent);
                modalTitle.textContent = `Edit: ${stepEl.querySelector('h4').textContent}`;
                let formHtml = '';
                if (stepType === 'form') {
                    formHtml = `<div><label class="block text-sm font-medium text-slate-700 mb-1">Form Title</label><input id="modal-form-title" class="w-full p-2 border rounded-md" placeholder="e.g., Contact Information" value="${data.title || ''}"></div><div class="mt-4"><h4 class="text-md font-semibold text-slate-800 mb-2">Questions</h4><div id="modal-questions-container" class="space-y-4"></div><button id="modal-add-question-btn" type="button" class="mt-3 text-sm text-indigo-600 hover:text-indigo-800 font-semibold flex items-center"><i data-feather="plus-circle" class="w-4 h-4 mr-1"></i> Add Question</button></div>`;
                    modalBody.innerHTML = formHtml;
                    const container = document.getElementById('modal-questions-container');
                    data.questions.forEach(q => addFormQuestionInput(container, q));
                    document.getElementById('modal-add-question-btn').onclick = () => addFormQuestionInput(container);
                } else {
                    if (stepType.includes('question')) {
                         formHtml += `<div><label class="block text-sm font-medium text-slate-700 mb-1">Question Text</label><textarea id="modal-main-input" class="w-full p-2 border rounded-md" placeholder="Enter your text here...">${data.value || ''}</textarea></div><div class="mt-4"><label class="block text-sm font-medium text-slate-700 mb-1">Variable Name <span class="text-slate-400 font-normal">(for database)</span></label><input id="modal-variable-name" type="text" class="w-full p-2 border rounded-md bg-slate-50 font-mono text-sm" placeholder="e.g., user_name" value="${data.variableName || ''}"><p class="text-xs text-slate-500 mt-1">No spaces or special characters. Use underscores.</p></div>`;
                    } else {
                         formHtml += `<div><label class="block text-sm font-medium text-slate-700 mb-1">Message Text</label><textarea id="modal-main-input" class="w-full p-2 border rounded-md" placeholder="Enter your message...">${data.value || ''}</textarea></div>`;
                    }
                    if (stepType === 'question-multiple-choice') {
                        formHtml += `<div class="mt-4"><div class="grid grid-cols-2 gap-2 mb-1"><label class="block text-sm font-medium text-slate-700">Options Label</label><label class="block text-sm font-medium text-slate-700">Value <span class="text-slate-400 font-normal">(optional)</span></label></div><div id="modal-options-container" class="space-y-2 mt-1"></div><button id="modal-add-option-btn" type="button" class="mt-2 text-sm text-indigo-600 hover:text-indigo-800 font-semibold flex items-center"><i data-feather="plus-circle" class="w-4 h-4 mr-1"></i> Add Option</button></div>`;
                    }
                     modalBody.innerHTML = formHtml;
                    if (stepType === 'question-multiple-choice') {
                        const container = document.getElementById('modal-options-container');
                        if(data.options) data.options.forEach(opt => addOptionInput(container, opt));
                        document.getElementById('modal-add-option-btn').onclick = () => addOptionInput(container);
                    }
                }
                feather.replace();
                modalOverlay.dataset.editingStepId = stepEl.id;
                modalOverlay.classList.add('active');
            }
            function addFormQuestionInput(container, questionData = {}) { /* ... Function content hidden for brevity ... */ }
            function addOptionInput(container, option = { label: '', value: '' }) { /* ... Function content hidden for brevity ... */ }
            function closeModal() { modalOverlay.classList.remove('active'); modalBody.innerHTML = ''; delete modalOverlay.dataset.editingStepId; }
            function saveModalChanges() { /* ... Function content hidden for brevity ... */ }
            function updateStepDisplay(stepEl) { /* ... Function content hidden for brevity ... */ }
            
            modalSaveBtn.addEventListener('click', saveModalChanges);
            modalCancelBtn.addEventListener('click', closeModal);
            modalOverlay.addEventListener('click', (e) => { if(e.target === modalOverlay) closeModal(); });

            generateBtn.addEventListener('click', () => {
                const steps = [];
                previewBoard.querySelectorAll('.preview-step').forEach(stepEl => {
                    const type = stepEl.dataset.stepType;
                    const data = JSON.parse(stepEl.querySelector('.step-data').textContent);
                    steps.push({ type, ...data });
                });
                if (steps.length === 0) {
                    codeOutput.textContent = "Please add at least one step to the preview board.";
                    copyBtn.disabled = true;
                    downloadBtn.disabled = true;
                    return;
                }
                const botId = crypto.randomUUID();
                const botHtml = generateBotHtml(steps, botId);
                codeOutput.textContent = botHtml;
                copyBtn.disabled = false;
                downloadBtn.disabled = false;
            });

            copyBtn.addEventListener('click', function() { /* ... Function content hidden for brevity ... */ });
            downloadBtn.addEventListener('click', function() { /* ... Function content hidden for brevity ... */ });
            
            // --- FULL HTML GENERATION FUNCTION ---
            // THIS IS THE CORRECT, COMPLETE FUNCTION
            function generateBotHtml(steps, botId) {
                const stepsJson = JSON.stringify(steps, null, 2);
                return `<!-- Bot ID: ${botId} -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbot</title>
    <script src="https://cdn.tailwindcss.com"><\/script>
    <style>
        .chat-container { max-height: 80vh; }
        .chat-bubble-bot { background-color: #eef2ff; color: #312e81; }
        .chat-bubble-user { background-color: #1e40af; color: #ffffff; }
        .option-btn { cursor: pointer; }
        .form-container-in-chat { background-color: white; padding: 1rem; border-radius: 0.5rem; border: 1px solid #e2e8f0; }
    </style>
</head>
<body class="bg-slate-100 flex items-center justify-center h-screen">
    <div class="w-full max-w-md mx-auto bg-white rounded-2xl shadow-xl flex flex-col">
        <div class="p-4 border-b bg-blue-900 text-white rounded-t-2xl"><h2 class="text-xl font-bold">Chat with our Bot</h2></div>
        <div id="chat-box" class="flex-1 p-6 overflow-y-auto chat-container"></div>
        <div id="input-area" class="p-4 border-t bg-slate-50 rounded-b-2xl"></div>
    </div>
    <script>
        const WEB_APP_URL = 'PASTE_YOUR_DATABASE_ENDPOINT_URL_HERE'; // e.g., A Google Apps Script URL or your own API endpoint
        const chatBox = document.getElementById('chat-box');
        const inputArea = document.getElementById('input-area');
        const botId = '${botId}';
        const conversationSteps = ${stepsJson};
        let currentStepIndex = 0;
        const collectedData = {};

        function addMessage(message, sender, isHtml = false) {
            const bubble = document.createElement('div');
            const messageWrapper = document.createElement('div');
            messageWrapper.className = 'mb-4 flex ' + (sender === 'bot' ? 'justify-start' : 'justify-end');
            bubble.className = 'max-w-xs p-3 rounded-xl ' + (sender === 'bot' ? 'chat-bubble-bot' : 'chat-bubble-user');
            if (isHtml) { bubble.innerHTML = message; } else { bubble.textContent = message; }
            messageWrapper.appendChild(bubble);
            chatBox.appendChild(messageWrapper);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function showOptions(options) {
            inputArea.innerHTML = '';
            const optionsContainer = document.createElement('div');
            optionsContainer.className = 'flex flex-wrap gap-2 p-2 justify-center';
            options.forEach(option => {
                const button = document.createElement('button');
                button.className = 'option-btn px-4 py-2 border border-blue-500 text-blue-600 rounded-full hover:bg-blue-100 transition-colors';
                button.textContent = option.label;
                button.onclick = () => handleOptionClick(option);
                optionsContainer.appendChild(button);
            });
            inputArea.appendChild(optionsContainer);
        }

        function handleOptionClick(option) {
            addMessage(option.label, 'user');
            const step = conversationSteps[currentStepIndex];
            if (step.variableName) { collectedData[step.variableName] = option.value; }
            restoreTextInput();
            currentStepIndex++;
            setTimeout(processNextStep, 1000);
        }

        function restoreTextInput() {
             inputArea.style.display = 'block';
             inputArea.innerHTML = \`<div class="flex gap-2"><input type="text" id="user-input" class="flex-1 px-4 py-2 border rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Type a message..." disabled><button id="send-btn" class="px-6 py-2 bg-blue-600 text-white rounded-full hover:bg-blue-700 disabled:bg-slate-400" disabled>Send</button></div>\`;
            document.getElementById('send-btn').addEventListener('click', handleUserInput);
            document.getElementById('user-input').addEventListener('keypress', e => e.key === 'Enter' && handleUserInput());
        }

        async function processNextStep() {
            if (currentStepIndex >= conversationSteps.length) { disableInput(); return; }
            const step = conversationSteps[currentStepIndex];
            switch(step.type) {
                case 'welcome-message': case 'show-message':
                    addMessage(step.value, 'bot');
                    currentStepIndex++;
                    setTimeout(processNextStep, 1000);
                    break;
                case 'end-conversation':
                    disableInput();
                    addMessage('Saving your responses...', 'bot');
                    await saveData();
                    addMessage(step.value, 'bot');
                    break;
                case 'question-text': addMessage(step.value, 'bot'); enableInput(); break;
                case 'question-multiple-choice': addMessage(step.value, 'bot'); showOptions(step.options); break;
                case 'form': addMessage(step.title, 'bot'); displayForm(step); break;
            }
        }
        
        function displayForm(step) {
            inputArea.style.display = 'none';
            const formId = \`form-\${currentStepIndex}\`;
            let formHtml = \`<div class="form-container-in-chat space-y-4"><form id="\${formId}">\`;
            step.questions.forEach(q => {
                const inputName = q.variableName || q.id;
                formHtml += \`<div class="flex flex-col"><label class="mb-1 text-sm font-medium text-slate-700">\${q.label} \${q.required ? '<span class="text-red-500">*</span>' : ''}</label>\`;
                if (q.type === 'multiple-choice') {
                    formHtml += \`<select name="\${inputName}" class="p-2 border rounded-md" \${q.required ? 'required' : ''}><option value="">Select an option</option>\`;
                    q.options.forEach(opt => { formHtml += \`<option value="\${opt.value}">\${opt.label}</option>\`; });
                    formHtml += \`</select>\`;
                } else {
                    formHtml += \`<input type="\${q.type}" name="\${inputName}" class="p-2 border rounded-md" \${q.required ? 'required' : ''}>\`;
                }
                 formHtml += \`</div>\`;
            });
            formHtml += \`<button type="submit" class="w-full mt-4 px-6 py-2 bg-blue-600 text-white rounded-full hover:bg-blue-700 disabled:bg-slate-400">Submit</button></form></div>\`;
            addMessage(formHtml, 'bot', true);
            const formElement = document.getElementById(formId);
            const submitButton = formElement.querySelector('button[type="submit"]');
            submitButton.disabled = !formElement.checkValidity(); 
            formElement.addEventListener('input', () => { submitButton.disabled = !formElement.checkValidity(); });
            formElement.addEventListener('submit', (e) => { e.preventDefault(); handleFormSubmit(formElement, step); });
        }
        
        function handleFormSubmit(formElement, step) {
            const formData = new FormData(formElement);
            let summary = '<strong class="font-bold">Your submission:</strong><ul class="list-disc list-inside mt-1">';
            for(let [name, value] of formData.entries()) {
                const question = step.questions.find(q => (q.variableName || q.id) === name);
                const label = question ? question.label : name;
                summary += \`<li><strong>\${label}:</strong> \${value}</li>\`;
                collectedData[name] = value;
            }
            summary += '</ul>';
            formElement.parentElement.innerHTML = '<p class="text-center font-semibold text-green-600">Form submitted successfully!</p>';
            addMessage(summary, 'user', true);
            restoreTextInput();
            currentStepIndex++;
            setTimeout(processNextStep, 1000);
        }

        function handleUserInput() {
            const input = document.getElementById('user-input'); if (!input) return;
            const message = input.value.trim(); if (!message) return;
            addMessage(message, 'user');
            const step = conversationSteps[currentStepIndex];
            if (step.variableName) { collectedData[step.variableName] = message; }
            input.value = '';
            disableInput();
            currentStepIndex++;
            setTimeout(processNextStep, 1000);
        }
        
        async function saveData() {
            if (!WEB_APP_URL || WEB_APP_URL === 'PASTE_YOUR_DATABASE_ENDPOINT_URL_HERE') {
                console.error("Database endpoint URL is not set. Data not sent.");
                return;
            }
            const dataToSend = { ...collectedData, timestamp: new Date().toISOString(), botId: botId };
            try {
                await fetch(WEB_APP_URL, {
                    method: 'POST',
                    mode: 'no-cors', // Important for many serverless backends like Google Apps Script
                    headers: { "Content-Type": "application/json", },
                    body: JSON.stringify(dataToSend)
                });
                console.log("Data submission completed.");
            } catch (error) {
                console.error('Error sending data:', error);
                addMessage('Sorry, there was an error saving your response.', 'bot');
            }
        }

        function enableInput() { const i = document.getElementById('user-input'), s = document.getElementById('send-btn'); if(i)i.disabled=false; if(s)s.disabled=false; if(i)i.focus(); }
        function disableInput() { const i = document.getElementById('user-input'), s = document.getElementById('send-btn'); if(i)i.disabled=true; if(s)s.disabled=true; }
        
        restoreTextInput();
        setTimeout(processNextStep, 500);
    <\/script>
</body>
</html>`;
            }

            document.getElementById('logout-button').addEventListener('click', logout);
            // Hide full function bodies for brevity in this view
            const fnsToHide = { addFormQuestionInput, addOptionInput, saveModalChanges, updateStepDisplay, copyBtn, downloadBtn };
            for (const fnName in fnsToHide) {
                const fn = eval(fnName);
                if(fn.tagName === 'BUTTON') {
                     if (fnName === 'copyBtn') {
                        fn.addEventListener('click', function() {
                            navigator.clipboard.writeText(codeOutput.textContent).then(() => {
                                const originalText = this.innerHTML;
                                this.innerHTML = '<i data-feather="check" class="w-4 h-4 mr-2"></i> Copied!';
                                feather.replace();
                                setTimeout(() => { this.innerHTML = originalText; feather.replace(); }, 2000);
                            });
                        });
                    } else if (fnName === 'downloadBtn') {
                         fn.addEventListener('click', function() {
                            const blob = new Blob([codeOutput.textContent], { type: 'text/html' });
                            const a = document.createElement('a');
                            a.href = URL.createObjectURL(blob);
                            a.download = 'generated-chatbot.html';
                            a.click();
                            URL.revokeObjectURL(a.href);
                        });
                    }
                }
            }
        }

        window.onload = async () => {
            await initAuth0();
            await handleAuthCallback();
            await updateUI();
            document.getElementById('login-button').addEventListener('click', login);
        };
    </script>
</body>
</html>
