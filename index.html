<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbot Builder</title>
    
    <!-- Third-party Scripts & Fonts -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Auth0 SDK -->
    <script src="https://cdn.auth0.com/js/auth0-spa-js/2.0/auth0-spa-js.production.js"></script>
    
    <!-- Custom Styles -->
    <link rel="stylesheet" href="styles.css">
</head>
<body class="bg-slate-100">

    <!-- Auth0 Login View -->
    <div id="login-view" class="flex items-center justify-center h-screen">
        <div class="text-center p-8 bg-white shadow-lg rounded-xl">
            <h1 class="text-3xl font-bold mb-2">Chatbot Builder</h1>
            <p class="text-slate-600 mb-6">Please log in to continue.</p>
            <button id="login-button" class="bg-indigo-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-indigo-700 transition">Log In</button>
        </div>
    </div>

    <!-- Chatbot Builder View (Initially Hidden) -->
    <div id="chat-view" class="hidden p-4 md:p-8">
        <div class="max-w-7xl mx-auto">
            <header class="text-center mb-8">
                 <div class="flex justify-between items-center mb-4">
                    <div></div> <!-- Spacer -->
                    <div class="inline-flex items-center bg-indigo-100 text-indigo-700 py-2 px-4 rounded-full">
                        <i data-feather="zap" class="w-5 h-5 mr-2"></i>
                        <h1 class="text-2xl md:text-4xl font-bold tracking-tight">BotBuilder <span class="text-indigo-600">Buzz</span></h1>
                    </div>
                    <button id="logout-button" class="bg-slate-200 text-slate-700 font-semibold py-2 px-4 rounded-lg hover:bg-slate-300 transition">Log Out</button>
                </div>
                <p class="text-slate-600 max-w-2xl mx-auto">Visually craft your chatbot conversation flow. Drag steps from the builder, configure them, and generate the code instantly.</p>
            </header>

            <main class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
                <!-- Step Builder -->
                <aside class="lg:col-span-1 bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                    <h2 class="text-lg font-semibold mb-4 text-slate-800 border-b pb-3">Step Builder</h2>
                    <div id="step-builder" class="space-y-3">
                        <div class="step-item bg-white p-4 rounded-lg border flex items-center shadow-xs" draggable="true" data-step-type="welcome-message">
                            <i data-feather="message-square" class="w-5 h-5 mr-3 text-indigo-500"></i>
                            <div><h3 class="font-semibold text-sm text-slate-700">Welcome Message</h3><p class="text-xs text-slate-500">Starts the conversation.</p></div>
                        </div>
                        <div class="step-item bg-white p-4 rounded-lg border flex items-center shadow-xs" draggable="true" data-step-type="question-text">
                            <i data-feather="help-circle" class="w-5 h-5 mr-3 text-sky-500"></i>
                            <div><h3 class="font-semibold text-sm text-slate-700">Question (Text)</h3><p class="text-xs text-slate-500">Asks user for text input.</p></div>
                        </div>
                        <div class="step-item bg-white p-4 rounded-lg border flex items-center shadow-xs" draggable="true" data-step-type="question-multiple-choice">
                            <i data-feather="list" class="w-5 h-5 mr-3 text-purple-500"></i>
                            <div><h3 class="font-semibold text-sm text-slate-700">Question (Multiple Choice)</h3><p class="text-xs text-slate-500">Asks user to choose an option.</p></div>
                        </div>
                        <div class="step-item bg-white p-4 rounded-lg border flex items-center shadow-xs" draggable="true" data-step-type="form">
                            <i data-feather="file-text" class="w-5 h-5 mr-3 text-orange-500"></i>
                            <div><h3 class="font-semibold text-sm text-slate-700">Form</h3><p class="text-xs text-slate-500">Display a form with multiple questions.</p></div>
                        </div>
                        <div class="step-item bg-white p-4 rounded-lg border flex items-center shadow-xs" draggable="true" data-step-type="show-message">
                            <i data-feather="align-left" class="w-5 h-5 mr-3 text-emerald-500"></i>
                            <div><h3 class="font-semibold text-sm text-slate-700">Show Message</h3><p class="text-xs text-slate-500">Displays a message from the bot.</p></div>
                        </div>
                        <div class="step-item bg-white p-4 rounded-lg border flex items-center shadow-xs" draggable="true" data-step-type="end-conversation">
                            <i data-feather="flag" class="w-5 h-5 mr-3 text-red-500"></i>
                            <div><h3 class="font-semibold text-sm text-slate-700">End Conversation</h3><p class="text-xs text-slate-500">Finishes the chat flow.</p></div>
                        </div>
                    </div>
                </aside>

                <!-- Bot Preview Board -->
                <section class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-sm border border-slate-200 relative">
                    <h2 class="text-lg font-semibold mb-4 text-slate-800 border-b pb-3">Bot Preview Board</h2>
                    <div id="bot-preview-board" class="p-4 rounded-lg space-y-4 relative"></div>
                    <div id="drop-placeholder" class="placeholder-center text-center text-slate-400">
                        <i data-feather="move" class="w-10 h-10 mx-auto mb-2"></i>
                        <p class="font-medium">Drag and drop steps here</p>
                    </div>
                </section>
            </main>

            <!-- Generated Code Section -->
            <section class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                <div class="flex flex-col sm:flex-row items-center justify-between mb-4 gap-4">
                    <h2 class="text-lg font-semibold text-slate-800">Generated Bot Code</h2>
                    <div class="flex items-center gap-2">
                        <button id="generate-btn" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 transition duration-300 flex items-center"><i data-feather="code" class="w-4 h-4 mr-2"></i>Generate Bot Code</button>
                        <button id="copy-btn" class="bg-slate-200 text-slate-700 font-semibold py-2 px-4 rounded-lg hover:bg-slate-300 transition duration-300 flex items-center" disabled><i data-feather="copy" class="w-4 h-4 mr-2"></i>Copy Code</button>
                        <button id="download-btn" class="bg-slate-200 text-slate-700 font-semibold py-2 px-4 rounded-lg hover:bg-slate-300 transition duration-300 flex items-center" disabled><i data-feather="download" class="w-4 h-4 mr-2"></i>Download HTML</button>
                    </div>
                </div>
                <div id="generated-bot-content" class="bg-slate-900 text-white rounded-lg p-4 font-mono text-sm overflow-x-auto min-h-[200px]">
                    <pre><code id="code-output">Click "Generate Bot Code" to see the result here.</code></pre>
                </div>
            </section>
        </div>
    </div>
    
    <!-- Modal for Editing Steps -->
    <div id="edit-modal-overlay" class="modal-overlay">
        <div class="modal-content">
            <h3 id="modal-title" class="text-lg font-bold mb-4">Edit Step</h3>
            <div id="modal-body" class="space-y-4"></div>
            <div class="flex justify-end gap-3 mt-6">
                <button id="modal-cancel-btn" class="bg-slate-200 text-slate-700 font-semibold py-2 px-4 rounded-lg hover:bg-slate-300">Cancel</button>
                <button id="modal-save-btn" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700">Save Changes</button>
            </div>
        </div>
    </div>

    <script>
        let auth0Client = null;

        // --- AUTH0 AUTHENTICATION LOGIC ---

        async function initAuth0() {
            try {
                auth0Client = await auth0.createAuth0Client({
                    domain: 'dev-mz8c8fsonw81ep0j.us.auth0.com',
                    clientId: 'FPVfw1307EHppIuL8elWrE6KcBzS8Ubq',
                    authorizationParams: {
                        redirect_uri: window.location.origin
                    }
                });
            } catch (err) {
                console.error("Error initializing Auth0 client:", err);
            }
        }

        async function login() {
            try {
                await auth0Client.loginWithRedirect();
            } catch (err) {
                console.error("Login failed:", err);
            }
        }

        function logout() {
            auth0Client.logout({
                logoutParams: {
                    returnTo: window.location.origin
                }
            });
        }

        async function handleAuthCallback() {
            const isAuthenticated = await auth0Client.isAuthenticated();
            if (isAuthenticated) {
                await updateUI();
                return;
            }
            const query = window.location.search;
            if (query.includes("code=") && query.includes("state=")) {
                await auth0Client.handleRedirectCallback();
                await updateUI();
                window.history.replaceState({}, document.title, "/");
            }
        }

        async function updateUI() {
            const isAuthenticated = await auth0Client.isAuthenticated();
            document.getElementById('login-view').classList.toggle('hidden', isAuthenticated);
            document.getElementById('chat-view').classList.toggle('hidden', !isAuthenticated);

            if (isAuthenticated) {
                // Initialize the builder logic ONLY after user is logged in
                initializeBuilder();
            }
        }
        
        // --- BOT BUILDER LOGIC ---

        function initializeBuilder() {
            // This function is called by updateUI after a successful login
            
            feather.replace(); // Initialize Feather Icons

            const stepBuilder = document.getElementById('step-builder');
            const previewBoard = document.getElementById('bot-preview-board');
            const generateBtn = document.getElementById('generate-btn');
            const copyBtn = document.getElementById('copy-btn');
            const downloadBtn = document.getElementById('download-btn');
            const codeOutput = document.getElementById('code-output');
            
            // Modal elements
            const modalOverlay = document.getElementById('edit-modal-overlay');
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body');
            const modalSaveBtn = document.getElementById('modal-save-btn');
            const modalCancelBtn = document.getElementById('modal-cancel-btn');


            // --- Drag and Drop Logic (Builder to Preview) ---

            const stepItems = stepBuilder.querySelectorAll('.step-item');
            stepItems.forEach(item => {
                item.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('text/plain', item.dataset.stepType);
                    setTimeout(() => item.classList.add('dragging'), 0);
                });
                item.addEventListener('dragend', () => item.classList.remove('dragging'));
            });

            previewBoard.addEventListener('dragover', (e) => {
                e.preventDefault();
                // Handle visual feedback for both reordering and new item drop
                const draggingElement = document.querySelector('.dragging-preview');
                if (draggingElement) {
                    const afterElement = getDragAfterElement(previewBoard, e.clientY);
                    if (afterElement == null) {
                        previewBoard.appendChild(draggingElement);
                    } else {
                        previewBoard.insertBefore(draggingElement, afterElement);
                    }
                } else {
                    previewBoard.classList.add('drag-over');
                }
            });

            previewBoard.addEventListener('dragleave', () => previewBoard.classList.remove('drag-over'));
            
            previewBoard.addEventListener('drop', (e) => {
                e.preventDefault();
                previewBoard.classList.remove('drag-over');
                const stepType = e.dataTransfer.getData('text/plain');
                if (stepType) { // Only add if it's a new step from the builder
                    addStepToPreview(stepType);
                    e.dataTransfer.clearData();
                }
            });
            
            // --- Reordering Logic within Preview Board ---
            previewBoard.addEventListener('dragstart', e => {
                if (e.target.classList.contains('preview-step')) {
                    setTimeout(() => e.target.classList.add('dragging-preview'), 0);
                }
            });

            previewBoard.addEventListener('dragend', e => {
                if (e.target.classList.contains('preview-step')) {
                    e.target.classList.remove('dragging-preview');
                }
            });

            function getDragAfterElement(container, y) {
                const draggableElements = [...container.querySelectorAll('.preview-step:not(.dragging-preview)')];

                return draggableElements.reduce((closest, child) => {
                    const box = child.getBoundingClientRect();
                    const offset = y - box.top - box.height / 2;
                    if (offset < 0 && offset > closest.offset) {
                        return { offset: offset, element: child };
                    } else {
                        return closest;
                    }
                }, { offset: Number.NEGATIVE_INFINITY }).element;
            }


            // --- Dynamic Step Creation, Deletion, and Editing ---

            let stepIdCounter = 0;
            function addStepToPreview(stepType) {
                const stepId = `step-${stepIdCounter++}`;
                const tempDiv = document.createElement('div');
                
                let initialData, title, icon, color;

                switch(stepType) {
                    case 'welcome-message': 
                        [title, icon, color] = ['Welcome Message', 'message-square', 'indigo'];
                        initialData = { value: '', options: [] };
                        break;
                    case 'question-text':
                        [title, icon, color] = ['Question (Text)', 'help-circle', 'sky'];
                        initialData = { value: '', options: [], variableName: '' };
                        break;
                    case 'question-multiple-choice':
                        [title, icon, color] = ['Question (Multiple Choice)', 'list', 'purple'];
                        initialData = { value: '', options: [], variableName: '' };
                        break;
                    case 'form':
                        [title, icon, color] = ['Form', 'file-text', 'orange'];
                        initialData = { title: '', questions: [] };
                        break;
                    case 'show-message':
                        [title, icon, color] = ['Show Message', 'align-left', 'emerald'];
                        initialData = { value: '', options: [] };
                        break;
                    case 'end-conversation':
                        [title, icon, color] = ['End Conversation', 'flag', 'red'];
                        initialData = { value: '', options: [] };
                        break;
                    default: return;
                }
                
                tempDiv.innerHTML = createStepElement(stepId, title, icon, color, stepType);
                const stepElement = tempDiv.firstElementChild;
                stepElement.querySelector('.step-data').textContent = JSON.stringify(initialData);

                previewBoard.appendChild(stepElement);
                feather.replace();
            }

            function createStepElement(id, title, icon, color, stepType) {
                 return `
                    <div id="${id}" class="preview-step bg-slate-50 p-4 rounded-lg border border-${color}-200 shadow-sm" data-step-type="${stepType}" draggable="true">
                        <div class="step-data" style="display: none;"></div>
                        <div class="flex justify-between items-center">
                            <div class="flex items-center" style="cursor: grab;">
                                <i data-feather="${icon}" class="w-5 h-5 mr-3 text-${color}-500"></i>
                                <h4 class="font-semibold text-slate-700">${title}</h4>
                            </div>
                            <div class="flex items-center gap-2">
                                <button class="edit-step-btn text-slate-400 hover:text-indigo-500 transition-colors"><i data-feather="edit" class="w-5 h-5" style="pointer-events: none;"></i></button>
                                <button class="delete-step-btn text-slate-400 hover:text-red-500 transition-colors"><i data-feather="x-circle" class="w-5 h-5" style="pointer-events: none;"></i></button>
                            </div>
                        </div>
                        <div class="step-content-display text-sm text-slate-600 mt-2 p-2 rounded-md bg-white border min-h-[40px] italic">Click the edit button to configure this step.</div>
                    </div>
                `;
            }

            previewBoard.addEventListener('click', (e) => {
                const deleteButton = e.target.closest('.delete-step-btn');
                if (deleteButton) {
                    deleteButton.closest('.preview-step').remove();
                }

                const editButton = e.target.closest('.edit-step-btn');
                if (editButton) {
                    openModal(editButton.closest('.preview-step'));
                }
            });
            
            // --- Modal Logic ---
            let questionIdCounter = 0;
            function openModal(stepEl) {
                const stepType = stepEl.dataset.stepType;
                const data = JSON.parse(stepEl.querySelector('.step-data').textContent);
                modalTitle.textContent = `Edit: ${stepEl.querySelector('h4').textContent}`;
                
                let formHtml = '';

                if (stepType === 'form') {
                    formHtml = `<div><label class="block text-sm font-medium text-slate-700 mb-1">Form Title</label><input id="modal-form-title" class="w-full p-2 border rounded-md" placeholder="e.g., Contact Information" value="${data.title || ''}"></div><div class="mt-4"><h4 class="text-md font-semibold text-slate-800 mb-2">Questions</h4><div id="modal-questions-container" class="space-y-4"></div><button id="modal-add-question-btn" type="button" class="mt-3 text-sm text-indigo-600 hover:text-indigo-800 font-semibold flex items-center"><i data-feather="plus-circle" class="w-4 h-4 mr-1"></i> Add Question</button></div>`;
                    modalBody.innerHTML = formHtml;
                    const container = document.getElementById('modal-questions-container');
                    data.questions.forEach(q => addFormQuestionInput(container, q));
                    document.getElementById('modal-add-question-btn').onclick = () => addFormQuestionInput(container);
                } else {
                    if (stepType.includes('question')) {
                         formHtml += `<div><label class="block text-sm font-medium text-slate-700 mb-1">Question Text</label><textarea id="modal-main-input" class="w-full p-2 border rounded-md" placeholder="Enter your text here...">${data.value || ''}</textarea></div><div class="mt-4"><label class="block text-sm font-medium text-slate-700 mb-1">Variable Name <span class="text-slate-400 font-normal">(for database)</span></label><input id="modal-variable-name" type="text" class="w-full p-2 border rounded-md bg-slate-50 font-mono text-sm" placeholder="e.g., user_name" value="${data.variableName || ''}"><p class="text-xs text-slate-500 mt-1">No spaces or special characters. Use underscores.</p></div>`;
                    } else {
                         formHtml += `<div><label class="block text-sm font-medium text-slate-700 mb-1">Message Text</label><textarea id="modal-main-input" class="w-full p-2 border rounded-md" placeholder="Enter your message...">${data.value || ''}</textarea></div>`;
                    }
                    if (stepType === 'question-multiple-choice') {
                        formHtml += `<div class="mt-4"><div class="grid grid-cols-2 gap-2 mb-1"><label class="block text-sm font-medium text-slate-700">Options Label</label><label class="block text-sm font-medium text-slate-700">Value <span class="text-slate-400 font-normal">(optional)</span></label></div><div id="modal-options-container" class="space-y-2 mt-1"></div><button id="modal-add-option-btn" type="button" class="mt-2 text-sm text-indigo-600 hover:text-indigo-800 font-semibold flex items-center"><i data-feather="plus-circle" class="w-4 h-4 mr-1"></i> Add Option</button></div>`;
                    }
                     modalBody.innerHTML = formHtml;
                    if (stepType === 'question-multiple-choice') {
                        const container = document.getElementById('modal-options-container');
                        if(data.options) data.options.forEach(opt => addOptionInput(container, opt));
                        document.getElementById('modal-add-option-btn').onclick = () => addOptionInput(container);
                    }
                }
                feather.replace();
                modalOverlay.dataset.editingStepId = stepEl.id;
                modalOverlay.classList.add('active');
            }

            function addFormQuestionInput(container, questionData = {}) {
                const questionId = `q-${questionIdCounter++}`;
                const div = document.createElement('div');
                div.className = 'p-3 border rounded-md bg-slate-50 relative';
                div.dataset.questionId = questionId;
                div.innerHTML = `<button type="button" class="remove-question-btn absolute -top-2 -right-2 text-slate-400 hover:text-red-500 bg-white rounded-full"><i data-feather="x-circle" class="w-5 h-5" style="pointer-events: none;"></i></button><div class="grid grid-cols-2 gap-x-4 gap-y-3"><div class="col-span-2"><label class="block text-xs font-medium text-slate-600 mb-1">Question Label</label><input type="text" class="question-label w-full p-2 border rounded-md text-sm" placeholder="e.g., What is your name?" value="${questionData.label || ''}"></div><div class="col-span-2"><label class="block text-xs font-medium text-slate-600 mb-1">Variable Name <span class="text-slate-400 font-normal">(for DB)</span></label><input type="text" class="question-variable-name w-full p-2 border rounded-md text-sm bg-white font-mono" placeholder="e.g., user_email" value="${questionData.variableName || ''}"></div><div><label class="block text-xs font-medium text-slate-600 mb-1">Question Type</label><select class="question-type w-full p-2 border rounded-md text-sm"><option value="text" ${questionData.type === 'text' ? 'selected' : ''}>Text</option><option value="number" ${questionData.type === 'number' ? 'selected' : ''}>Number</option><option value="date" ${questionData.type === 'date' ? 'selected' : ''}>Date</option><option value="multiple-choice" ${questionData.type === 'multiple-choice' ? 'selected' : ''}>Multiple Choice</option></select></div><div class="flex items-end"><label class="flex items-center gap-2"><input type="checkbox" class="question-required h-4 w-4 rounded border-gray-300 text-indigo-600" ${questionData.required ? 'checked' : ''}><span class="text-sm font-medium text-slate-700">Required</span></label></div></div><div class="question-options-wrapper mt-3" style="${questionData.type !== 'multiple-choice' ? 'display: none;' : ''}"><div class="grid grid-cols-2 gap-2 mb-1"><label class="block text-xs font-medium text-slate-600">Option Label</label><label class="block text-xs font-medium text-slate-600">Value</label></div><div class="modal-options-container space-y-2 mt-1"></div><button type="button" class="modal-add-option-btn mt-2 text-xs text-indigo-600 hover:text-indigo-800 font-semibold flex items-center"><i data-feather="plus-circle" class="w-3 h-3 mr-1"></i> Add Option</button></div>`;
                const optionsContainer = div.querySelector('.modal-options-container');
                if (questionData.type === 'multiple-choice' && questionData.options) {
                    questionData.options.forEach(opt => addOptionInput(optionsContainer, opt));
                }
                div.querySelector('.modal-add-option-btn').onclick = () => addOptionInput(optionsContainer);
                div.querySelector('.remove-question-btn').onclick = () => div.remove();
                div.querySelector('.question-type').onchange = (e) => {
                    div.querySelector('.question-options-wrapper').style.display = e.target.value === 'multiple-choice' ? 'block' : 'none';
                };
                container.appendChild(div);
                feather.replace();
            }
            
            function addOptionInput(container, option = { label: '', value: '' }) {
                const div = document.createElement('div');
                div.className = 'grid grid-cols-2 items-center gap-2';
                div.innerHTML = `<input type="text" class="modal-option-label w-full p-2 border rounded-md bg-white text-sm" placeholder="Label (e.g., Yes)" value="${option.label || ''}"><div class="flex items-center gap-2"><input type="text" class="modal-option-value flex-1 p-2 border rounded-md bg-slate-50 text-sm font-mono" placeholder="Value (e.g., 1)" value="${option.value || ''}"><button type="button" class="remove-option-btn text-slate-400 hover:text-red-500"><i data-feather="minus-circle" class="w-4 h-4" style="pointer-events: none;"></i></button></div>`;
                div.querySelector('.remove-option-btn').onclick = () => div.remove();
                container.appendChild(div);
                feather.replace();
            }

            function closeModal() {
                modalOverlay.classList.remove('active');
                modalBody.innerHTML = '';
                delete modalOverlay.dataset.editingStepId;
            }

            function saveModalChanges() {
                const stepId = modalOverlay.dataset.editingStepId;
                if (!stepId) return;
                const stepEl = document.getElementById(stepId);
                const stepType = stepEl.dataset.stepType;
                let newData;

                if (stepType === 'form') {
                    newData = { title: '', questions: [] };
                    newData.title = document.getElementById('modal-form-title').value;
                    document.querySelectorAll('#modal-questions-container > div').forEach(qEl => {
                        const question = { id: qEl.dataset.questionId, label: qEl.querySelector('.question-label').value.trim(), variableName: qEl.querySelector('.question-variable-name').value.trim().replace(/\s+/g, '_').toLowerCase(), type: qEl.querySelector('.question-type').value, required: qEl.querySelector('.question-required').checked, options: [] };
                        if (question.type === 'multiple-choice') {
                             qEl.querySelectorAll('.modal-options-container > div').forEach(optEl => {
                                const label = optEl.querySelector('.modal-option-label').value.trim();
                                const value = optEl.querySelector('.modal-option-value').value.trim();
                                if (label) { question.options.push({ label: label, value: value || label }); }
                            });
                        }
                        if (question.label) { newData.questions.push(question); }
                    });
                } else {
                    newData = { value: '', options: [] };
                    newData.value = document.getElementById('modal-main-input').value;
                    if (stepType.includes('question')) {
                        const variableInput = document.getElementById('modal-variable-name');
                        if(variableInput) { newData.variableName = variableInput.value.trim().replace(/\s+/g, '_').toLowerCase(); }
                    }
                    if (stepType === 'question-multiple-choice') {
                        document.querySelectorAll('#modal-options-container > div').forEach(optEl => {
                            const label = optEl.querySelector('.modal-option-label').value.trim();
                            const value = optEl.querySelector('.modal-option-value').value.trim();
                            if (label) { newData.options.push({ label: label, value: value || label }); }
                        });
                    }
                }
                stepEl.querySelector('.step-data').textContent = JSON.stringify(newData);
                updateStepDisplay(stepEl);
                closeModal();
            }
            
            function updateStepDisplay(stepEl) {
                 const data = JSON.parse(stepEl.querySelector('.step-data').textContent);
                 const displayEl = stepEl.querySelector('.step-content-display');
                 const stepType = stepEl.dataset.stepType;
                 let hasContent = false;
                 let contentHtml = '';

                 if (stepType === 'form') {
                     if (data.title || (data.questions && data.questions.length > 0)) {
                         hasContent = true;
                         contentHtml += `<p class="font-medium text-slate-800 break-words">${data.title || '<em>(No form title)</em>'}</p>`;
                         if (data.questions && data.questions.length > 0) {
                             contentHtml += '<ul class="list-disc list-inside mt-2 text-slate-600 text-xs space-y-1">';
                             data.questions.forEach(q => {
                                 const variableBadge = q.variableName ? `<span class="ml-2 px-1.5 py-0.5 text-xs rounded-full bg-slate-200 text-slate-600 font-mono">${q.variableName}</span>` : '';
                                 contentHtml += `<li class="break-words">${q.label}${q.required ? ' *' : ''} <span class="text-slate-400">(${q.type})</span>${variableBadge}</li>`;
                                 if (q.type === 'multiple-choice' && q.options.length > 0) {
                                     contentHtml += '<ul class="list-none pl-5 mt-1">';
                                     q.options.forEach(opt => { contentHtml += `<li class="text-xs break-words"> &ndash; ${opt.label} <span class="text-slate-400 font-mono">(val: ${opt.value})</span></li>`; });
                                     contentHtml += '</ul>';
                                 }
                             });
                             contentHtml += '</ul>';
                         }
                     }
                 } else {
                     if (data.value || (data.options && data.options.length > 0)) {
                         hasContent = true;
                         contentHtml += `<p class="font-medium text-slate-800 break-words">${data.value || '<em>(No text provided)</em>'}</p>`;
                         if(data.variableName) { contentHtml += `<div class="mt-2"><span class="px-2 py-1 text-xs rounded-full bg-slate-200 text-slate-600 font-mono">Variable: ${data.variableName}</span></div>`; }
                         if (data.options && data.options.length > 0) {
                             contentHtml += '<ul class="list-disc list-inside mt-2 text-slate-600">';
                             data.options.forEach(opt => { contentHtml += `<li class="break-words">${opt.label} <span class="text-slate-500 font-mono text-xs">(value: ${opt.value})</span></li>`; });
                             contentHtml += '</ul>';
                         }
                     }
                 }
                 if (hasContent) {
                     displayEl.innerHTML = contentHtml;
                     displayEl.classList.remove('italic');
                 } else {
                     displayEl.innerHTML = `Click the edit button to configure this step.`;
                     displayEl.classList.add('italic');
                 }
            }
            
            modalSaveBtn.addEventListener('click', saveModalChanges);
            modalCancelBtn.addEventListener('click', closeModal);
            modalOverlay.addEventListener('click', (e) => { if(e.target === modalOverlay) closeModal(); });

            // --- Button Functionality ---
            generateBtn.addEventListener('click', () => {
                const steps = [];
                previewBoard.querySelectorAll('.preview-step').forEach(stepEl => {
                    const type = stepEl.dataset.stepType;
                    const data = JSON.parse(stepEl.querySelector('.step-data').textContent);
                    steps.push({ type, ...data });
                });
                if (steps.length === 0) {
                    codeOutput.textContent = "Please add at least one step to the preview board.";
                    copyBtn.disabled = true;
                    downloadBtn.disabled = true;
                    return;
                }
                const botId = crypto.randomUUID();
                const botHtml = generateBotHtml(steps, botId);
                codeOutput.textContent = botHtml;
                copyBtn.disabled = false;
                downloadBtn.disabled = false;
            });

            copyBtn.addEventListener('click', function() {
                navigator.clipboard.writeText(codeOutput.textContent).then(() => {
                    const originalText = this.innerHTML;
                    this.innerHTML = '<i data-feather="check" class="w-4 h-4 mr-2"></i> Copied!';
                    feather.replace();
                    setTimeout(() => { this.innerHTML = originalText; feather.replace(); }, 2000);
                });
            });

            downloadBtn.addEventListener('click', function() {
                const blob = new Blob([codeOutput.textContent], { type: 'text/html' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = 'generated-chatbot.html';
                a.click();
                URL.revokeObjectURL(a.href);
            });
            
            // --- HTML Generation Function ---
            function generateBotHtml(steps, botId) {
                const stepsJson = JSON.stringify(steps, null, 2);
                return `<!-- Your Bot Code -->`; // Placeholder for generated code
            }

            // Bind logout button inside the builder
            document.getElementById('logout-button').addEventListener('click', logout);
        }

        // --- INITIAL PAGE LOAD ---

        window.onload = async () => {
            await initAuth0();
            await handleAuthCallback();
            await updateUI();
            
            // Bind login button
            document.getElementById('login-button').addEventListener('click', login);
        };
    </script>
</body>
</html>
